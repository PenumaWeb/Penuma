<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verify OTP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fade in animation */
    .fade-in {
      animation: fadeIn 0.8s ease forwards;
      opacity: 0;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    /* Input pulse on focus */
    input:focus {
      animation: pulse 1.5s infinite;
      outline: none;
      border-color: #2563eb; /* Tailwind blue-600 */
      box-shadow: 0 0 8px #3b82f6;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 8px #3b82f6; }
      50% { box-shadow: 0 0 20px #60a5fa; }
    }
    /* Button press animation */
    button:active {
      transform: scale(0.98);
      transition: transform 0.1s ease;
    }
    /* Thin circular progress ring container */
    .progress-ring {
      position: relative;
      width: 48px;
      height: 48px;
      margin: 0 auto 12px auto;
    }
    .progress-ring circle {
      fill: transparent;
      stroke: #2563eb;
      stroke-width: 4;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 0.35s ease;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
  <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none"></canvas>

  <div class="bg-white max-w-md w-full rounded-lg shadow-lg p-6 fade-in">
    <h1 class="text-2xl font-semibold mb-4 text-center">Enter Your OTP</h1>
    <p id="info-text" class="text-gray-700 mb-4 text-center whitespace-pre-line"></p>

    <!-- Progress ring shown during sending OTP -->
    <div id="progress-ring-container" class="progress-ring hidden" aria-label="OTP sending progress" role="progressbar" aria-valuemin="0" aria-valuemax="30" aria-valuenow="0">
      <svg width="48" height="48">
        <circle
          stroke="#2563eb"
          stroke-width="4"
          fill="transparent"
          r="20"
          cx="24"
          cy="24"
          id="progress-ring-circle"
          stroke-dasharray="125.6"
          stroke-dashoffset="125.6"
        />
      </svg>
    </div>

    <input
      id="otp-input"
      type="text"
      placeholder="Enter OTP"
      maxlength="10"
      class="w-full p-3 border border-gray-300 rounded-md mb-4 text-center text-xl font-mono transition-shadow duration-300"
      autocomplete="off"
      spellcheck="false"
    />

    <button
      id="verify-btn"
      class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-semibold py-3 rounded-md disabled:opacity-60"
    >
      Verify OTP
    </button>

    <button
      id="resend-btn"
      class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-2 rounded-md mt-4 hidden"
      disabled
    >
      Resend OTP
    </button>

    <p id="status" class="mt-4 text-center text-sm min-h-[1.25rem]"></p>
  </div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
  const params = new URLSearchParams(window.location.search);
  const resource = params.get("resource");
  const email = params.get("email");

  const infoText = document.getElementById("info-text");
  const statusEl = document.getElementById("status");
  const otpInput = document.getElementById("otp-input");
  const verifyBtn = document.getElementById("verify-btn");
  const resendBtn = document.getElementById("resend-btn");

  // Progress ring elements
  const progressRingContainer = document.getElementById('progress-ring-container');
  const progressCircle = document.getElementById('progress-ring-circle');

  // Circle circumference (2Ï€r)
  const radius = progressCircle.r.baseVal.value;
  const circumference = 2 * Math.PI * radius;

  progressCircle.style.strokeDasharray = `${circumference}`;
  progressCircle.style.strokeDashoffset = `${circumference}`;

  // Countdown for resend
  const RESEND_DELAY = 30; // seconds
  let countdown = RESEND_DELAY;
  let countdownInterval;

  if (!resource || !email) {
    infoText.textContent = "Missing resource or email in the URL.";
    verifyBtn.disabled = true;
  } else {
    infoText.textContent = `Resource: ${resource}\nEmail: ${email}`;
    // On load, start countdown for resend (hide resend initially)
    resetResendCountdown();
  }

  function setProgress(percent) {
    const offset = circumference - (percent / 100) * circumference;
    progressCircle.style.strokeDashoffset = offset;
  }

  function launchConfetti() {
    const duration = 3 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { 
      origin: { y: 0.7 }, 
      particleCount: 50, 
      spread: 60,
      ticks: 100,
      gravity: 0.5,
      scalar: 1.2
    };

    function frame() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) return;

      const particleCount = Math.floor((timeLeft / duration) * defaults.particleCount);

      confetti({
        ...defaults,
        particleCount,
        origin: { x: Math.random(), y: 0.7 }
      });

      requestAnimationFrame(frame);
    }
    frame();
  }

  // Start resend countdown UI
  function resetResendCountdown() {
    resendBtn.disabled = true;
    resendBtn.classList.add('hidden');
    countdown = RESEND_DELAY;
    clearInterval(countdownInterval);
  }

  function startResendCountdown() {
    resendBtn.disabled = true;
    resendBtn.textContent = `Resend OTP in ${countdown}s`;
    resendBtn.classList.remove('hidden');

    countdownInterval = setInterval(() => {
      countdown--;
      resendBtn.textContent = `Resend OTP in ${countdown}s`;

      if (countdown <= 0) {
        clearInterval(countdownInterval);
        resendBtn.textContent = "Resend OTP";
        resendBtn.disabled = false;
      }
    }, 1000);
  }

  // Function to send OTP (for resend button)
  function sendOtp() {
    statusEl.textContent = "Sending new OTP...";
    statusEl.style.color = "black";
    verifyBtn.disabled = true;
    resendBtn.disabled = true;
    otpInput.value = "";
    progressRingContainer.classList.remove('hidden');

    let progress = 0;
    setProgress(0);

    // Animate the progress ring for 5 seconds while sending OTP
    let sendDuration = 5000; // 5 seconds
    let startTime = Date.now();

    let progressAnim = setInterval(() => {
      const elapsed = Date.now() - startTime;
      progress = Math.min((elapsed / sendDuration) * 100, 100);
      setProgress(progress);
      if (progress >= 100) {
        clearInterval(progressAnim);
        progressRingContainer.classList.add('hidden');
      }
    }, 50);

    // Call API to resend OTP (modify URL to your API)
    fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=resend&resource=" + encodeURIComponent(resource) + "&email=" + encodeURIComponent(email))
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          statusEl.textContent = "OTP Sent! Please check your email.";
          statusEl.style.color = "green";
          launchConfetti();
          startResendCountdown();
          verifyBtn.disabled = false;
        } else {
          statusEl.textContent = data.error || "Failed to send OTP. Try again later.";
          statusEl.style.color = "red";
          verifyBtn.disabled = false;
          resendBtn.disabled = false;
        }
      })
      .catch(err => {
        statusEl.textContent = "Server error: " + err.message;
        statusEl.style.color = "red";
        verifyBtn.disabled = false;
        resendBtn.disabled = false;
        progressRingContainer.classList.add('hidden');
      });
  }

  resendBtn.addEventListener('click', () => {
    sendOtp();
  });

  verifyBtn.addEventListener("click", () => {
    const otp = otpInput.value.trim();
    if (!otp) {
      statusEl.textContent = "Please enter the OTP.";
      statusEl.style.color = "red";
      return;
    }

    statusEl.textContent = "Verifying OTP...";
    statusEl.style.color = "black";
    verifyBtn.disabled = true;

    fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=verify&resource=" + encodeURIComponent(resource) + "&email=" + encodeURIComponent(email) + "&otp=" + encodeURIComponent(otp))
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          statusEl.textContent = "OTP verified! Redirecting...";
          statusEl.style.color = "green";
          launchConfetti();

          setTimeout(() => {
            const url = new URL(window.location.origin + "/download.html");
            url.searchParams.set("resource", resource);
            url.searchParams.set("email", email);
            window.location.href = url.toString();
          }, 2500);
        } else {
          statusEl.textContent = data.error || "Invalid OTP. Please try again.";
          statusEl.style.color = "red";
          verifyBtn.disabled = false;
        }
      })
      .catch(err => {
        statusEl.textContent = "Server error: " + err.message;
        statusEl.style.color = "red";
        verifyBtn.disabled = false;
      });
  });
</script>
</body>
</html>
