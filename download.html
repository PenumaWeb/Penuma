<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Download Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="p-6 bg-gray-100 min-h-screen flex flex-col items-center justify-center"
  >
    <h1 class="text-2xl font-bold mb-4">Download Your Resource</h1>

    <p id="resource-name" class="mb-4 text-lg"></p>

    <p>
      Please enter the temporary password (OTP) you received to unlock the
      download:
    </p>
    <input
      id="otp-input"
      type="text"
      class="border p-2 rounded mb-4"
      placeholder="Enter OTP"
    />

    <button
      id="verify-btn"
      class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
    >
      Verify OTP & Download
    </button>

    <p id="status" class="mt-4 text-sm"></p>

   <script>
  const params = new URLSearchParams(window.location.search);
  const resource = params.get("resource");

  const resourceNameEl = document.getElementById("resource-name");
  const statusEl = document.getElementById("status");
  const otpInput = document.getElementById("otp-input");
  const verifyBtn = document.getElementById("verify-btn");

  if (!resource) {
    resourceNameEl.textContent = "Error: No resource specified.";
    verifyBtn.disabled = true;
  } else {
    resourceNameEl.textContent = `Resource: ${resource}`;
  }

  const resourceLinks = {
    "grade-13-mockexam1-part1":
      "https://drive.google.com/file/d/1HAqYNgK57xAAVBuWBG5DBZURSsNIORfW/view?usp=drive_link",
    "grade-13-mockexam1-part2":
      "https://drive.google.com/file/d/1sBCVXQ8s-M46duuI30w2h_ltjtZSaCKu/view?usp=drive_link",
    "grade-13-mockexam2-part2":
      "https://drive.google.com/file/d/1bFo_e-J91-POZShuQ_rkZ5dh-V2yxCZq/view?usp=drive_link",
    "grade-13-mockexam3-part1":
      "https://drive.google.com/file/d/1hTneTtkU0ckpLu0R1-sPb6HtWH41Glwg/view?usp=drive_link",
  };

  verifyBtn.addEventListener("click", () => {
    const enteredOtp = otpInput.value.trim();
    if (!enteredOtp) {
      statusEl.textContent = "Please enter the OTP.";
      statusEl.style.color = "red";
      return;
    }

    statusEl.textContent = "Verifying OTP...";
    statusEl.style.color = "black";
    verifyBtn.disabled = true;

    const callbackName = "otpCallback_" + Math.floor(Math.random() * 1000000);
    window[callbackName] = function (data) {
      if (data.success) {
        statusEl.textContent = "OTP verified! Starting download...";
        statusEl.style.color = "green";

        const downloadUrl = resourceLinks[resource];
        if (downloadUrl) {
          // Clean up
          delete window[callbackName];
          script.remove();

          window.location.href = downloadUrl;
        } else {
          statusEl.textContent = "Download link not found for this resource.";
          statusEl.style.color = "red";
          verifyBtn.disabled = false;
        }
      } else {
        statusEl.textContent = data.message || "Invalid OTP. Please try again.";
        statusEl.style.color = "red";
        verifyBtn.disabled = false;
        delete window[callbackName];
        script.remove();
      }
    };

    const script = document.createElement("script");
    script.src =
      "https://script.google.com/macros/s/AKfycbyjpfAOJlob2hcAy6KP57o-2_w_Kwmgpi_wb8BwwiuJNu70MXWPPWPiETR4U4xLXevy/exec" +
      "?action=verifyTempPassword&tempPassword=" +
      encodeURIComponent(enteredOtp) +
      "&resourceName=" +
      encodeURIComponent(resource) +
      "&callback=" +
      callbackName;

    document.body.appendChild(script);
  });
</script>
